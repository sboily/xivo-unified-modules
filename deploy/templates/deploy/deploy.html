{% extends "base.html" %}
{% block content %}

<div class="container">

<div class="widget stacked widget-table action-table">
  <p class="text-right"><a class="btn btn-primary btn-small" href="{{url_for('deploy.deploy_add')}}"><i class="icon-plus icon-white"></i> {{_('Add') }}</a></p>
  <p class="text-right"><a class="btn btn-primary btn-small" href="{{url_for('deploy.provider_add')}}"><i class="icon-plus icon-white"></i> {{_('Add provider') }}</a></p>
  <table class="table table-bordered">
  <table class="table table-bordered table-striped table-highlight">
    <thead>
      <tr>
        <th>{{ _('Name') }}</th>
        <th>{{ _('Status') }}</th>
        <th>{{ _('IP') }}</th>
        <th>{{ _('Instance') }}</th>
        <th>{{ _('Created at') }}</th>
      <th class="td-actions"></th>
      </tr>
    </thead>
    <tbody>
    {% for s in servers %}
      <tr>
      <td>{{ s.name }}</td>
      <td class="status" id="status-{{ s.id }}">
      <div class="progress progress-warning">
          <div class="bar" id="status-{{ s.id }}" data-percentage="0"></div>
      </div>
      </td>
      <td class="ip" id="ip-{{ s.id }}">{% if s.address %}<a href="https://{{ s.address }}" target="_blank">{{ s.address }}</a>{% endif %}</td>
      <td class="instance" id="instance-{{ s.id }}">{{ s.instance_ec2 }}</td>
      <td>{{ s.created_time }}</td>
      <td class="td-actions">
        <a href="{{url_for('deploy.deploy_del', id=s.id)}}" class="btn btn-small"><i class="btn-icon-only icon-remove"></i></a>
        {% if not s.status %}
            <a href="{{url_for('deploy.deploy_cloud', id=s.id)}}" class="btn btn-small"><i class="btn-icon-only icon-upload"></i></a>
        {% endif %}
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>

<script>


function loadStatus() {
    $('.progress .bar').progressbar({
        display_text: 2,
        use_percentage: true,
        });

        $.getJSON('/deploy/status',
            function(data) {
                $.each( data, function( key, val ) {
                    if (val.status != 'running' && val.progress != '') {
                    $('.bar#status-' + key).attr('data-percentage', val.progress); }
                    else { $('.status#status-' + key).attr('id', 'status-'+key).text(val.status); };
                    $('.ip#ip-' + key).attr('id', 'ip-'+key).html('<a href="https://' + val.ip + '" target="_blank">' + val.ip + '</a>');
                    $('.instance#instance-' + key).attr('id', 'instance-'+key).text(val.instance);
                })
            });
    setTimeout(loadStatus, 2000);
    }

loadStatus();

</script> 

</div>

{% endblock %}
